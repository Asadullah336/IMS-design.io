<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Home Expense Manager with Login & Chart</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f7f9fc;
    margin: 0;
    padding: 0;
  }
  .container {
    max-width: 1100px;
    margin: 40px auto;
    background: white;
    border-radius: 10px;
    padding: 30px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  }
  h1, h2 {
    text-align: center;
    margin-bottom: 20px;
  }
  form {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 20px;
  }
  form > div {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    width: 100%;
  }
  form input, form select {
    padding: 10px;
    font-size: 16px;
  }
  #date {
    flex: 1 1 150px;
  }
  #item {
    flex: 1 1 150px;
  }
  #quantity {
    flex: 1 1 80px;
  }
  #unit {
    flex: 1 1 100px;
  }
  #amount {
    flex: 1 1 100px;
  }
  form button {
    width: 1100px;
    background: #28a745;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 6px;
    padding: 10px;
    font-size: 16px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    padding: 10px;
    text-align: center;
    border: 1px solid #ddd;
  }
  thead {
    background-color: #007bff;
    color: white;
  }
  .actions button {
    margin: 0 5px;
    padding: 5px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .edit {
    background-color: #ffc107;
  }
  .delete {
    background-color: #dc3545;
    color: white;
  }
  .total, .monthly-report {
    font-weight: bold;
    margin-top: 20px;
    text-align: right;
  }
  #chartContainer {
    margin-top: 30px;
  }
  #logoutBtn {
    float: right;
    background: #dc3545;
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
  }
  /* Login styles */
  #loginPage {
    max-width: 400px;
    margin: 80px auto;
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.15);
    position: relative;
  }
  #loginPage h2 {
    margin-bottom: 25px;
  }
  #loginPage input {
    width: 100%;
    padding: 12px 40px 12px 12px;
    margin-bottom: 15px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-sizing: border-box;
  }
  #loginPage button {
    width: 100%;
    background: #007bff;
    color: white;
    padding: 12px;
    font-size: 18px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  #loginError {
    color: red;
    margin-bottom: 12px;
    text-align: center;
  }
  #togglePassword {
    position: absolute;
    right: 40px;
    top: 152px;
    cursor: pointer;
    font-size: 18px;
    user-select: none;
    color: #666;
  }
  #togglePassword:hover {
    color: #000;
  }
  /* PDF export button style */
  #exportPDFBtn {
    margin-top: 20px;
    padding: 12px 20px;
    font-size: 16px;
    background: #007bff;
    border: none;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    width: 100%;
  }
  #exportPDFBtn:hover {
    background: #0056b3;
  }
  /* Search Bar */
  #searchBar {
    margin-bottom: 15px;
    padding: 10px;
    width: 98%;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage">
  <h2>Login to Home Expense Manager</h2>
  <div id="loginError"></div>
  <input type="text" id="usernameInput" placeholder="Username" autocomplete="off" />
  <input type="password" id="passwordInput" placeholder="Password" autocomplete="off" />
  <span id="togglePassword" title="Show/Hide Password"></span>
  <button onclick="login()">Login</button>
</div>

<!-- MAIN APP -->
<div class="container" id="app" style="display:none;">
  <button id="logoutBtn" onclick="logout()">Logout</button>
  <h1>Home Expense Manager</h1>

  <!-- Add Expense Form -->
  <form id="expenseForm">
    <div>
      <input type="date" id="date" required />
      <input type="text" id="item" placeholder="Item" required />
      <input type="number" id="quantity" placeholder="Qty" step="0.01" min="0.01" required />
      <select id="unit">
        <option>gram</option>
        <option>kg</option>
        <option>litre</option>
        <option>piece</option>
      </select>
      <input type="number" id="amount" placeholder="Total ₹" step="0.01" min="0.01" required />
    </div>
    <button type="submit">Add</button>
  </form>

  <!-- Search Bar -->
  <input type="text" id="searchBar" placeholder="Search by Item or Date..." oninput="filterExpenses()" />

  <!-- Expense Table -->
  <table>
    <thead>
      <tr>
        <th>S.No</th>
        <th>Date</th>
        <th>Item</th>
        <th>Qty</th>
        <th>Unit</th>
        <th>Amount (₹)</th>
        <th>Price/Unit (₹)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="expenseTableBody"></tbody>
  </table>

  <div class="total">Total: ₹<span id="totalAmount">0.00</span></div>

  <div class="monthly-report" id="monthlyReport"></div>

  <div id="chartContainer">
    <canvas id="monthlyChart" width="100%" height="40"></canvas>
  </div>

  <button id="exportPDFBtn" onclick="exportPDF()">Export Items to PDF</button>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- html2pdf CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

<script>
  // ---- Login System ----
  const users = {
    "admin": "admin123",
    "user": "password"
  };

  let currentUser = null;

  function login() {
    const username = document.getElementById("usernameInput").value.trim();
    const password = document.getElementById("passwordInput").value;

    if(users[username] && users[username] === password) {
      currentUser = username;
      localStorage.setItem("loggedInUser", currentUser);
      showApp();
      clearLoginForm();
      document.getElementById("loginError").textContent = "";
    } else {
      document.getElementById("loginError").textContent = "Invalid username or password!";
    }
  }

  function logout() {
    currentUser = null;
    localStorage.removeItem("loggedInUser");
    document.getElementById("app").style.display = "none";
    document.getElementById("loginPage").style.display = "block";
  }

  function showApp() {
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("app").style.display = "block";
    loadExpenses();
  }

  window.onload = () => {
    const loggedIn = localStorage.getItem("loggedInUser");
    if(loggedIn && users[loggedIn]) {
      currentUser = loggedIn;
      showApp();
    }
  };

  // Password toggle
  const togglePassword = document.getElementById('togglePassword');
  const passwordInput = document.getElementById('passwordInput');

  togglePassword.addEventListener('click', () => {
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    togglePassword.textContent = type === 'password' ? '' : '';
  });

  function clearLoginForm() {
    document.getElementById("usernameInput").value = "";
    document.getElementById("passwordInput").value = "";
  }

  // ---- Expense Manager ----
  const expenseForm = document.getElementById("expenseForm");
  const expenseTableBody = document.getElementById("expenseTableBody");
  const totalAmountSpan = document.getElementById("totalAmount");
  const monthlyReportDiv = document.getElementById("monthlyReport");

  let expenses = [];
  let editIndex = -1;

  expenseForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const date = document.getElementById("date").value;
    const item = document.getElementById("item").value.trim();
    const quantity = parseFloat(document.getElementById("quantity").value);
    const unit = document.getElementById("unit").value;
    const amount = parseFloat(document.getElementById("amount").value);

    if(!date || !item || isNaN(quantity) || quantity <= 0 || isNaN(amount) || amount <= 0) {
      alert("Please fill all fields correctly.");
      return;
    }

    if(editIndex === -1) {
      expenses.push({ date, item, quantity, unit, amount });
    } else {
      expenses[editIndex] = { date, item, quantity, unit, amount };
      editIndex = -1;
      expenseForm.querySelector("button[type=submit]").textContent = "Add";
    }

    saveExpenses();
    loadExpenses();
    expenseForm.reset();
  });

  function saveExpenses() {
    localStorage.setItem(`expenses_${currentUser}`, JSON.stringify(expenses));
  }

  function loadExpenses() {
    expenses = JSON.parse(localStorage.getItem(`expenses_${currentUser}`)) || [];
    renderExpenses();
  }

  function renderExpenses(filterText = "") {
    expenseTableBody.innerHTML = "";
    let total = 0;
    let filtered = expenses;

    if(filterText) {
      const lower = filterText.toLowerCase();
      filtered = expenses.filter(e =>
        e.item.toLowerCase().includes(lower) ||
        e.date.includes(lower)
      );
    }

    filtered.forEach((exp, i) => {
      const pricePerUnit = exp.amount / exp.quantity;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${exp.date}</td>
        <td>${exp.item}</td>
        <td>${exp.quantity.toFixed(2)}</td>
        <td>${exp.unit}</td>
        <td>₹${exp.amount.toFixed(2)}</td>
        <td>₹${pricePerUnit.toFixed(2)}</td>
        <td class="actions">
          <button class="edit" onclick="editExpense(${i})">Edit</button>
          <button class="delete" onclick="deleteExpense(${i})">Delete</button>
        </td>
      `;
      expenseTableBody.appendChild(tr);
      total += exp.amount;
    });

    totalAmountSpan.textContent = total.toFixed(2);
    updateMonthlyReport();
    updateChart();
  }

  function editExpense(index) {
    const exp = expenses[index];
    document.getElementById("date").value = exp.date;
    document.getElementById("item").value = exp.item;
    document.getElementById("quantity").value = exp.quantity;
    document.getElementById("unit").value = exp.unit;
    document.getElementById("amount").value = exp.amount;
    editIndex = index;
    expenseForm.querySelector("button[type=submit]").textContent = "Update";
  }

  function deleteExpense(index) {
    if(confirm("Are you sure you want to delete this expense?")) {
      expenses.splice(index, 1);
      saveExpenses();
      loadExpenses();
    }
  }

  function filterExpenses() {
    const searchText = document.getElementById("searchBar").value.trim();
    renderExpenses(searchText);
  }

  // Monthly report (group by month)
  function updateMonthlyReport() {
    const monthlyTotals = {};
    expenses.forEach(exp => {
      const m = exp.date.slice(0,7); // yyyy-mm
      monthlyTotals[m] = (monthlyTotals[m] || 0) + exp.amount;
    });

    let reportHtml = "<h2>Monthly Expenses</h2>";
    for(const month in monthlyTotals) {
      reportHtml += `<div>${month}: ₹${monthlyTotals[month].toFixed(2)}</div>`;
    }
    monthlyReportDiv.innerHTML = reportHtml;
  }

  // Chart.js for monthly expenses
  let chart = null;
  function updateChart() {
    const monthlyTotals = {};
    expenses.forEach(exp => {
      const m = exp.date.slice(0,7);
      monthlyTotals[m] = (monthlyTotals[m] || 0) + exp.amount;
    });

    const labels = Object.keys(monthlyTotals).sort();
    const data = labels.map(l => monthlyTotals[l]);

    const ctx = document.getElementById('monthlyChart').getContext('2d');

    if(chart) chart.destroy();

    chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Monthly Expenses (₹)',
          data,
          backgroundColor: 'rgba(0,123,255,0.7)'
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // Export PDF with table + totals + monthly report
  function exportPDF() {
    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';

    const thead = document.createElement('thead');
    thead.innerHTML = `
      <tr style="background:#007bff; color:#fff;">
        <th style="border:1px solid #ddd; padding:8px;">S.No</th>
        <th style="border:1px solid #ddd; padding:8px;">Date</th>
        <th style="border:1px solid #ddd; padding:8px;">Item</th>
        <th style="border:1px solid #ddd; padding:8px;">Qty</th>
        <th style="border:1px solid #ddd; padding:8px;">Unit</th>
        <th style="border:1px solid #ddd; padding:8px;">Amount (₹)</th>
        <th style="border:1px solid #ddd; padding:8px;">Price/Unit (₹)</th>
      </tr>
    `;

    const tbody = document.createElement('tbody');
    expenses.forEach((exp, i) => {
      const pricePerUnit = exp.amount / exp.quantity;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="border:1px solid #ddd; padding:6px; text-align:center;">${i + 1}</td>
        <td style="border:1px solid #ddd; padding:6px; text-align:center;">${exp.date}</td>
        <td style="border:1px solid #ddd; padding:6px; text-align:left;">${exp.item}</td>
        <td style="border:1px solid #ddd; padding:6px; text-align:center;">${exp.quantity.toFixed(2)}</td>
        <td style="border:1px solid #ddd; padding:6px; text-align:center;">${exp.unit}</td>
        <td style="border:1px solid #ddd; padding:6px; text-align:center;">₹${exp.amount.toFixed(2)}</td>
        <td style="border:1px solid #ddd; padding:6px; text-align:center;">₹${pricePerUnit.toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    });

    // Create totals row
    const totalRow = document.createElement('tr');
    const totalAmount = expenses.reduce((sum, e) => sum + e.amount, 0);
    totalRow.innerHTML = `
      <td colspan="5" style="border:1px solid #ddd; padding:8px; text-align:right; font-weight:bold;">Total</td>
      <td style="border:1px solid #ddd; padding:8px; text-align:center; font-weight:bold;">₹${totalAmount.toFixed(2)}</td>
      <td></td>
    `;
    tbody.appendChild(totalRow);

    thead.style.border = "1px solid #ddd";
    tbody.style.border = "1px solid #ddd";

    table.appendChild(thead);
    table.appendChild(tbody);

    // Monthly report for PDF
    const monthlyTotals = {};
    expenses.forEach(exp => {
      const m = exp.date.slice(0,7);
      monthlyTotals[m] = (monthlyTotals[m] || 0) + exp.amount;
    });

    const monthlyReportDivPdf = document.createElement('div');
    monthlyReportDivPdf.style.marginTop = '20px';
    monthlyReportDivPdf.style.fontWeight = 'bold';
    monthlyReportDivPdf.textContent = "Monthly Expenses:";

    for(const month in monthlyTotals) {
      const monthDiv = document.createElement('div');
      monthDiv.textContent = `${month}: ₹${monthlyTotals[month].toFixed(2)}`;
      monthlyReportDivPdf.appendChild(monthDiv);
    }

    // Container for PDF content
    const container = document.createElement('div');
    container.appendChild(table);
    container.appendChild(monthlyReportDivPdf);

    // Export using html2pdf
    html2pdf().from(container).set({
      margin: 10,
      filename: 'expense-report.pdf',
      html2canvas: { scale: 2 },
      jsPDF: { orientation: 'landscape' }
    }).save();
  }
</script>

</body>
</html>
